<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WoMaH - Work Management Hours</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    import React, { useState, useEffect } from 'react';
    import { Calendar, Clock, Users, BarChart3, Download, Upload, Plus, Trash2 } from 'lucide-react';

    const TimeTrackingApp = () => {
      const [currentUser, setCurrentUser] = useState(null);
      const [users, setUsers] = useState([]);
      const [events, setEvents] = useState([]);
      const [categorizedEvents, setCategorizedEvents] = useState([]);
      const [currentEventIndex, setCurrentEventIndex] = useState(0);
      const [view, setView] = useState('login');
      const [selectedPeriod, setSelectedPeriod] = useState('daily');
      const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
      const [selectedUser, setSelectedUser] = useState('all');
      const [loginUsername, setLoginUsername] = useState('');
      const [loginPassword, setLoginPassword] = useState('');
      const [isAdminLogin, setIsAdminLogin] = useState(false);

      const categories = {
        clientele: ['UHS Digital', 'UHS Supplier', 'UHS PMO', 'UHS Customer'],
        activity: ['Meeting/Planning', 'Building/Delivering', 'Jira Ticketing']
      };

      useEffect(() => {
        const savedUsers = JSON.parse(localStorage.getItem('timeTrackUsers') || '[]');
        const savedEvents = JSON.parse(localStorage.getItem('categorizedEvents') || '[]');
        setUsers(savedUsers);
        setCategorizedEvents(savedEvents);
      }, []);

      const saveToStorage = (key, data) => {
        localStorage.setItem(key, JSON.stringify(data));
      };

      const handleLogin = () => {
        if (!loginUsername || !loginPassword) return;
        
        let user = users.find(u => u.username === loginUsername && u.password === loginPassword);
        if (!user) {
          user = { username: loginUsername, password: loginPassword, isAdmin: isAdminLogin, id: Date.now() };
          const newUsers = [...users, user];
          setUsers(newUsers);
          saveToStorage('timeTrackUsers', newUsers);
        }
        setCurrentUser(user);
        setView('import');
      };

      const parseO365Events = (jsonData) => {
        try {
          const data = JSON.parse(jsonData);
          const parsedEvents = (data.value || data).map(event => {
            const start = new Date(event.start?.dateTime || event.start);
            const end = new Date(event.end?.dateTime || event.end);
            const hours = (end - start) / (1000 * 60 * 60);
            
            return {
              id: event.id || Math.random().toString(36),
              subject: event.subject || event.title || 'Untitled',
              start: start.toISOString(),
              end: end.toISOString(),
              hours: Math.round(hours * 100) / 100,
              date: start.toISOString().split('T')[0]
            };
          }).filter(e => {
            const hour = new Date(e.start).getHours();
            return hour >= 8 && hour < 18 && e.hours > 0;
          });
          
          setEvents(parsedEvents);
          setCurrentEventIndex(0);
          setView('categorize');
        } catch (error) {
          alert('Error parsing JSON. Please ensure it\'s valid O365 calendar export format.');
        }
      };

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => parseO365Events(event.target.result);
          reader.readAsText(file);
        }
      };

      const categorizeEvent = (clientele, activity) => {
        const event = events[currentEventIndex];
        const categorized = {
          ...event,
          clientele,
          activity,
          userId: currentUser.id,
          username: currentUser.username,
          categorizedAt: new Date().toISOString()
        };

        const newCategorized = [...categorizedEvents, categorized];
        setCategorizedEvents(newCategorized);
        saveToStorage('categorizedEvents', newCategorized);

        if (currentEventIndex < events.length - 1) {
          setCurrentEventIndex(currentEventIndex + 1);
        } else {
          setView('summary');
        }
      };

      const skipEvent = () => {
        if (currentEventIndex < events.length - 1) {
          setCurrentEventIndex(currentEventIndex + 1);
        } else {
          setView('summary');
        }
      };

      const calculateSummary = (period, date, userId = null) => {
        let filtered = categorizedEvents;
        
        if (userId && userId !== 'all') {
          filtered = filtered.filter(e => e.userId === parseInt(userId));
        }

        if (period === 'daily') {
          filtered = filtered.filter(e => e.date === date);
        } else if (period === 'weekly') {
          const weekStart = new Date(date);
          weekStart.setDate(weekStart.getDate() - weekStart.getDay());
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          filtered = filtered.filter(e => {
            const eventDate = new Date(e.date);
            return eventDate >= weekStart && eventDate <= weekEnd;
          });
        }

        const summary = {};
        filtered.forEach(event => {
          const key = `${event.clientele} - ${event.activity}`;
          summary[key] = (summary[key] || 0) + event.hours;
        });

        return { summary, total: Object.values(summary).reduce((a, b) => a + b, 0), count: filtered.length };
      };

      const exportData = () => {
        const data = {
          events: categorizedEvents,
          users: users.map(u => ({ username: u.username, id: u.id, isAdmin: u.isAdmin }))
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `womah-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
      };

      const clearData = () => {
        if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
          setCategorizedEvents([]);
          saveToStorage('categorizedEvents', []);
        }
      };

      const [selectedClientele, setSelectedClientele] = useState(null);

      // Login View
      if (view === 'login') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
              <div className="flex items-center justify-center mb-6">
                <Clock className="w-12 h-12 text-indigo-600 mr-3" />
                <h1 className="text-3xl font-bold text-gray-800">WoMaH</h1>
              </div>
              <div className="space-y-4">
                <input
                  type="text"
                  placeholder="Username"
                  value={loginUsername}
                  onChange={(e) => setLoginUsername(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                />
                <input
                  type="password"
                  placeholder="Password"
                  value={loginPassword}
                  onChange={(e) => setLoginPassword(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                />
                <label className="flex items-center text-sm text-gray-600">
                  <input 
                    type="checkbox" 
                    checked={isAdminLogin}
                    onChange={(e) => setIsAdminLogin(e.target.checked)}
                    className="mr-2" 
                  />
                  Login as Admin/Manager
                </label>
                <button
                  onClick={handleLogin}
                  className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition"
                >
                  Login / Register
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Import View
      if (view === 'import') {
        return (
          <div className="min-h-screen bg-gray-50 p-6">
            <div className="max-w-4xl mx-auto">
              <div className="bg-white rounded-lg shadow-lg p-8">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-gray-800">Import O365 Calendar Events</h2>
                  <button
                    onClick={() => setView('summary')}
                    className="text-indigo-600 hover:text-indigo-800 font-medium"
                  >
                    View Summary →
                  </button>
                </div>
                
                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                  <p className="text-sm text-gray-700 mb-2">
                    <strong>User:</strong> {currentUser.username}
                    {currentUser.isAdmin && <span className="ml-2 px-2 py-1 bg-indigo-600 text-white text-xs rounded">Admin</span>}
                  </p>
                  <p className="text-sm text-gray-600">
                    Upload a JSON export from your O365 calendar (events between 8am-6pm will be imported)
                  </p>
                </div>

                <div className="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-indigo-500 transition">
                  <Upload className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                  <input
                    type="file"
                    accept=".json"
                    onChange={handleFileUpload}
                    className="hidden"
                    id="fileUpload"
                  />
                  <label
                    htmlFor="fileUpload"
                    className="cursor-pointer bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition inline-block"
                  >
                    Select JSON File
                  </label>
                  <p className="text-sm text-gray-500 mt-4">Upload your O365 calendar export</p>
                </div>

                <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                  <p className="text-xs text-gray-600 font-semibold mb-2">How to export from O365:</p>
                  <ol className="text-xs text-gray-600 space-y-1 list-decimal list-inside">
                    <li>Open Outlook Calendar in browser</li>
                    <li>Select date range (8am-6pm events)</li>
                    <li>Export to JSON format</li>
                    <li>Upload the file here</li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Categorize View
      if (view === 'categorize') {
        const event = events[currentEventIndex];
        const progress = ((currentEventIndex + 1) / events.length) * 100;

        return (
          <div className="min-h-screen bg-gray-50 p-6">
            <div className="max-w-3xl mx-auto">
              <div className="bg-white rounded-lg shadow-lg p-8">
                <div className="mb-6">
                  <div className="flex justify-between items-center mb-2">
                    <h2 className="text-2xl font-bold text-gray-800">Categorize Events</h2>
                    <span className="text-sm text-gray-600">
                      {currentEventIndex + 1} / {events.length}
                    </span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div
                      className="bg-indigo-600 h-2 rounded-full transition-all"
                      style={{ width: `${progress}%` }}
                    />
                  </div>
                </div>

                <div className="mb-8 p-6 bg-indigo-50 rounded-lg">
                  <h3 className="text-xl font-bold text-gray-800 mb-2">{event.subject}</h3>
                  <div className="flex items-center text-sm text-gray-600 space-x-4">
                    <span className="flex items-center">
                      <Calendar className="w-4 h-4 mr-1" />
                      {new Date(event.start).toLocaleDateString()}
                    </span>
                    <span className="flex items-center">
                      <Clock className="w-4 h-4 mr-1" />
                      {new Date(event.start).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - 
                      {new Date(event.end).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </span>
                    <span className="font-semibold text-indigo-700">
                      {event.hours}h
                    </span>
                  </div>
                </div>

                {!selectedClientele ? (
                  <div className="space-y-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-3">Select Clientele:</label>
                    <div className="grid grid-cols-2 gap-3">
                      {categories.clientele.map(clientele => (
                        <button
                          key={clientele}
                          onClick={() => setSelectedClientele(clientele)}
                          className="px-6 py-3 bg-white border-2 border-indigo-600 text-indigo-600 rounded-lg hover:bg-indigo-50 transition font-medium"
                        >
                          {clientele}
                        </button>
                      ))}
                    </div>
                    <div className="flex space-x-3 mt-6">
                      <button
                        onClick={skipEvent}
                        className="flex-1 px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-medium"
                      >
                        Skip Event
                      </button>
                      <button
                        onClick={() => setView('summary')}
                        className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium"
                      >
                        Finish & View Summary
                      </button>
                    </div>
                  </div>
                ) : (
                  <div className="space-y-4">
                    <div className="flex items-center justify-between mb-3">
                      <label className="block text-sm font-semibold text-gray-700">
                        Select Activity for {selectedClientele}:
                      </label>
                      <button
                        onClick={() => setSelectedClientele(null)}
                        className="text-sm text-indigo-600 hover:text-indigo-800"
                      >
                        ← Back
                      </button>
                    </div>
                    <div className="grid grid-cols-1 gap-3">
                      {categories.activity.map(activity => (
                        <button
                          key={activity}
                          onClick={() => {
                            categorizeEvent(selectedClientele, activity);
                            setSelectedClientele(null);
                          }}
                          className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium"
                        >
                          {activity}
                        </button>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // Summary View
      if (view === 'summary') {
        const { summary, total, count } = calculateSummary(selectedPeriod, selectedDate, currentUser.isAdmin ? selectedUser : currentUser.id);

        return (
          <div className="min-h-screen bg-gray-50 p-6">
            <div className="max-w-6xl mx-auto">
              <div className="bg-white rounded-lg shadow-lg p-8">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                    <BarChart3 className="w-8 h-8 mr-3 text-indigo-600" />
                    Time Summary
                  </h2>
                  <div className="flex space-x-3">
                    <button
                      onClick={() => setView('import')}
                      className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center"
                    >
                      <Plus className="w-4 h-4 mr-2" />
                      Import More
                    </button>
                    {currentUser.isAdmin && (
                      <>
                        <button
                          onClick={exportData}
                          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Export
                        </button>
                        <button
                          onClick={clearData}
                          className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center"
                        >
                          <Trash2 className="w-4 h-4 mr-2" />
                          Clear All
                        </button>
                      </>
                    )}
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Period:</label>
                    <select
                      value={selectedPeriod}
                      onChange={(e) => setSelectedPeriod(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    >
                      <option value="daily">Daily</option>
                      <option value="weekly">Weekly</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Date:</label>
                    <input
                      type="date"
                      value={selectedDate}
                      onChange={(e) => setSelectedDate(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                    />
                  </div>
                  {currentUser.isAdmin && (
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">User:</label>
                      <select
                        value={selectedUser}
                        onChange={(e) => setSelectedUser(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                      >
                        <option value="all">All Users</option>
                        {users.map(user => (
                          <option key={user.id} value={user.id}>{user.username}</option>
                        ))}
                      </select>
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  <div className="bg-blue-50 p-6 rounded-lg">
                    <p className="text-sm text-gray-600 mb-1">Total Hours</p>
                    <p className="text-3xl font-bold text-indigo-600">{total.toFixed(1)}h</p>
                  </div>
                  <div className="bg-green-50 p-6 rounded-lg">
                    <p className="text-sm text-gray-600 mb-1">Events Categorized</p>
                    <p className="text-3xl font-bold text-green-600">{count}</p>
                  </div>
                  <div className="bg-purple-50 p-6 rounded-lg">
                    <p className="text-sm text-gray-600 mb-1">Period</p>
                    <p className="text-3xl font-bold text-purple-600 capitalize">{selectedPeriod}</p>
                  </div>
                </div>

                <div className="space-y-3">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">Breakdown by Category:</h3>
                  {Object.entries(summary).length === 0 ? (
                    <p className="text-gray-500 text-center py-8">No categorized events for this period</p>
                  ) : (
                    Object.entries(summary).map(([category, hours]) => (
                      <div key={category} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <span className="font-medium text-gray-800">{category}</span>
                        <div className="flex items-center space-x-4">
                          <div className="w-48 bg-gray-200 rounded-full h-3">
                            <div
                              className="bg-indigo-600 h-3 rounded-full"
                              style={{ width: `${(hours / total) * 100}%` }}
                            />
                          </div>
                          <span className="font-bold text-indigo-600 w-16 text-right">{hours.toFixed(1)}h</span>
                          <span className="text-sm text-gray-500 w-12 text-right">
                            {((hours / total) * 100).toFixed(0)}%
                          </span>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      return null;
    };

    ReactDOM.render(<TimeTrackingApp />, document.getElementById('root'));
  </script>
</body>
</html>
